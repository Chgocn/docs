> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7203563038301061181#heading-17)

å‰è¨€
==

æœ€è¿‘æˆ‘åœ¨å°ç ´ç«™å¼€å‘ä¸€æ¬¾æ–° Appï¼Œå«**é«˜èƒ½é“¾**ã€‚æˆ‘æ˜¯ä¸€ä¸ªå®Œç¾ä¸»ä¹‰è€…ï¼Œæ‰€ä»¥ä¸ç®¡å¯¹æ¶æ„è¿˜æ˜¯ UIï¼Œæˆ‘éƒ½æ˜¯æ¯”è¾ƒæŠ ç»†èŠ‚çš„ï¼Œåœ¨çŠ¶æ€æ å’Œå¯¼èˆªæ æ²‰æµ¸å¼è¿™ä¸€å—ï¼Œæˆ‘è¿˜æ˜¯è¸©äº†æŒºå¤šå‘ï¼Œè´¹äº†æŒºå¤šç²¾åŠ›çš„ã€‚è¿™æ¬¡æˆ‘å°†æˆ‘è¸©å‘ï¼Œé€‚é…å„æœºå‹æ€»ç»“å‡ºæ¥çš„å²ä¸Šæœ€å®Œç¾çš„ Android æ²‰æµ¸å¼çŠ¶æ€å¯¼èˆªæ æ”»ç•¥åˆ†äº«ç»™å¤§å®¶ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å» **[é«˜èƒ½é“¾å®˜ç½‘](https://link.juejin.cn?target=https%3A%2F%2Fwww.upowerchain.com%2F "https://www.upowerchain.com/")** ä¸‹è½½ä½“éªŒä¸€ä¸‹æˆ‘ä»¬çš„ Appï¼Œå®é™…æ„Ÿå—ä¸€ä¸‹æ²‰æµ¸å¼çŠ¶æ€å¯¼èˆªæ çš„æ•ˆæœï¼ˆç™»å½•ï¼Œå®åç­‰è´¦å·ç›¸å…³é¡µé¢ç”±äºä¸æ˜¯æˆ‘å¼€å‘çš„ï¼Œå°±æ²¡æœ‰é€‚é…æ²‰æµ¸å¼å¯¼èˆªæ å•¦ï¼Œå˜»å˜»ï¼‰

**æ³¨ï¼šæ­¤æ”»ç•¥åªé’ˆå¯¹ Android 5.0 åŠä»¥ä¸Šæœºå‹ï¼Œå³ minSdkVersion >= 21**

å®é™…æ•ˆæœ
====

åœ¨å¼€å§‹æ”»ç•¥ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å®Œç¾çš„æ²‰æµ¸å¼çŠ¶æ€å¯¼èˆªæ æ•ˆæœ

ä¼ ç»Ÿä¸‰é”®å¼å¯¼èˆªæ 
--------

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63207559882642af90a14b05f56a4e16~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c011db216d134c449bee9474ceea5860~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å…¨é¢å±å¯¼èˆªæ¡
------

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8dd192e3ac694064a640fd16c8e09b74~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a20b336f0174e4db7452fe3c8921990~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ç†è®ºåˆ†æ
====

åœ¨ä¸Šå…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹ï¼Œå®ç°æ²‰æµ¸å¼çŠ¶æ€å¯¼èˆªæ éœ€è¦å‡ æ­¥

1.  çŠ¶æ€æ å¯¼èˆªæ åº•è‰²é€æ˜
    
2.  æ ¹æ®å½“å‰é¡µé¢çš„èƒŒæ™¯è‰²ï¼Œç»™çŠ¶æ€æ å­—ä½“å’Œå¯¼èˆªæ æŒ‰é’®ï¼ˆæˆ–å¯¼èˆªæ¡ï¼‰è®¾ç½®äº®è‰²æˆ–æš—è‰²
    
3.  çŠ¶æ€æ å¯¼èˆªæ è®¾ç½®é€æ˜åï¼Œæˆ‘ä»¬é¡µé¢çš„å¸ƒå±€ä¼šå»¶ä¼¸åˆ°åŸæœ¬çŠ¶æ€æ å¯¼èˆªæ çš„ä½ç½®ï¼Œè¿™æ—¶å€™éœ€è¦ä¸€äº›æ‰‹æ®µå°†æˆ‘ä»¬éœ€è¦æ˜¾ç¤ºçš„æ­£æ–‡å†…å®¹å›ç¼©åˆ°å…¶æ­£ç¡®çš„æ˜¾ç¤ºèŒƒå›´å†…
    
    è¿™é‡Œæˆ‘ç»™å¤§å®¶æä¾›ä»¥ä¸‹å‡ ç§æ€è·¯ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œé€‰æ‹©ï¼š
    
    *   è®¾ç½®`fitsSystemWindows`å±æ€§
    *   æ ¹æ®çŠ¶æ€æ å¯¼èˆªæ çš„é«˜åº¦ï¼Œç»™æ ¹å¸ƒå±€è®¾ç½®ç›¸åº”çš„`paddingTop`å’Œ`paddingBottom`
    *   æ ¹æ®çŠ¶æ€æ å¯¼èˆªæ çš„é«˜åº¦ï¼Œç»™éœ€è¦ç§»ä½çš„æ§ä»¶è®¾ç½®ç›¸åº”çš„`marginTop`å’Œ`marginBottom`
    *   åœ¨é¡¶éƒ¨å’Œåº•éƒ¨å¢åŠ ä¸¤ä¸ªå ä½çš„`View`ï¼Œé«˜åº¦åˆ†åˆ«è®¾ç½®æˆçŠ¶æ€æ å’Œå¯¼èˆªæ çš„é«˜åº¦
    *   é’ˆå¯¹æ»‘åŠ¨è§†å›¾ï¼Œå·§ç”¨`clipChildren`å’Œ`clipToPadding`å±æ€§ï¼ˆå¯å‚ç…§é«˜èƒ½é“¾è—å“è¯¦æƒ…é¡µæ ·å¼ï¼‰

æ²‰æµ¸å¼çŠ¶æ€æ 
======

æ€è·¯è¯´å®Œäº†ï¼Œæˆ‘ä»¬ç°åœ¨å¼€å§‹è¿›å…¥å®æˆ˜ï¼Œæ²‰æµ¸å¼çŠ¶æ€æ æ¯”è¾ƒç®€å•ï¼Œæ²¡ä»€ä¹ˆå‘

çŠ¶æ€æ é€æ˜
-----

é¦–å…ˆç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å°†çŠ¶æ€æ çš„èƒŒæ™¯è®¾ç½®ä¸ºé€æ˜ï¼Œè¿™é‡Œæˆ‘ç›´æ¥æ”¾ä»£ç 

```
fun transparentStatusBar(window: Window) {
    window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS)
    window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS)
    var systemUiVisibility = window.decorView.systemUiVisibility
    systemUiVisibility =
        systemUiVisibility or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN or View.SYSTEM_UI_FLAG_LAYOUT_STABLE
    window.decorView.systemUiVisibility = systemUiVisibility
    window.statusBarColor = Color.TRANSPARENT

    //è®¾ç½®çŠ¶æ€æ æ–‡å­—é¢œè‰²
    setStatusBarTextColor(window, NightMode.isNightMode(window.context))
}


```

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†`FLAG_TRANSLUCENT_STATUS`è¿™ä¸ª`windowFlag`æ¢æˆ`FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS`ï¼Œå¦åˆ™çŠ¶æ€æ ä¸ä¼šå®Œå…¨é€æ˜ï¼Œä¼šæœ‰ä¸€ä¸ªåŠé€æ˜çš„ç°è‰²è’™å±‚

`FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS`è¿™ä¸ª`flag`è¡¨ç¤ºç³»ç»Ÿ`Bar`çš„èƒŒæ™¯å°†äº¤ç»™å½“å‰`window`ç»˜åˆ¶

`SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN`è¿™ä¸ª`flag`è¡¨ç¤º`Activity`å…¨å±æ˜¾ç¤ºï¼Œä½†çŠ¶æ€æ ä¸ä¼šè¢«éšè—ï¼Œä¾ç„¶å¯è§

`SYSTEM_UI_FLAG_LAYOUT_STABLE`è¿™ä¸ª`flag`è¡¨ç¤ºä¿æŒæ•´ä¸ª`View`ç¨³å®šï¼Œä½¿`View`ä¸ä¼šå› ä¸ºç³»ç»Ÿ UI çš„å˜åŒ–è€Œé‡æ–°`layout`

`SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN`å’Œ`SYSTEM_UI_FLAG_LAYOUT_STABLE`è¿™ä¸¤ä¸ª`flag`é€šå¸¸æ˜¯ä¸€èµ·ä½¿ç”¨çš„ï¼Œæˆ‘ä»¬è®¾ç½®è¿™ä¸¤ä¸ª`flag`ï¼Œç„¶åå†å°†`statusBarColor`è®¾ç½®ä¸ºé€æ˜ï¼Œå°±è¾¾æˆäº†çŠ¶æ€æ èƒŒæ™¯é€æ˜çš„æ•ˆæœ

çŠ¶æ€æ æ–‡å­—é¢œè‰²
-------

æ¥ç€æˆ‘ä»¬å°±è¯¥è®¾ç½®çŠ¶æ€æ æ–‡å­—é¢œè‰²äº†ï¼Œç»†å¿ƒçš„å°ä¼™ä¼´ä»¬åº”è¯¥å·²ç»æ³¨æ„åˆ°äº†ï¼Œæˆ‘åœ¨`transparentStatusBar`æ–¹æ³•çš„æœ«å°¾åŠ äº†ä¸€ä¸ª`setStatusBarTextColor`çš„æ–¹æ³•è°ƒç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯æ—¥é—´æ¨¡å¼ï¼Œé¡µé¢èƒŒæ™¯é€šå¸¸éƒ½æ˜¯äº®è‰²ï¼Œæ‰€ä»¥æ­¤æ—¶çŠ¶æ€æ æ–‡å­—é¢œè‰²è®¾ç½®ä¸ºé»‘è‰²æ¯”è¾ƒåˆç†ï¼Œè€Œåœ¨å¤œé—´æ¨¡å¼ä¸‹ï¼Œé¡µé¢èƒŒæ™¯é€šå¸¸éƒ½æ˜¯æš—è‰²ï¼Œæ­¤æ—¶çŠ¶æ€æ æ–‡å­—é¢œè‰²è®¾ç½®ä¸ºç™½è‰²æ¯”è¾ƒåˆç†ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹

```
fun setStatusBarTextColor(window: Window, light: Boolean) {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        var systemUiVisibility = window.decorView.systemUiVisibility
        systemUiVisibility = if (light) { //ç™½è‰²æ–‡å­—
            systemUiVisibility and View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR.inv()
        } else { //é»‘è‰²æ–‡å­—
            systemUiVisibility or View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR
        }
        window.decorView.systemUiVisibility = systemUiVisibility
    }
}


```

`Android 8.0`ä»¥ä¸Šæ‰æ”¯æŒå¯¼èˆªæ æ–‡å­—é¢œè‰²çš„ä¿®æ”¹ï¼Œ`SYSTEM_UI_FLAG_LIGHT_STATUS_BAR`è¿™ä¸ª`flag`è¡¨ç¤ºäº®è‰²çŠ¶æ€æ ï¼Œå³é»‘è‰²çŠ¶æ€æ æ–‡å­—ï¼Œæ‰€ä»¥å¦‚æœå¸Œæœ›çŠ¶æ€æ æ–‡å­—ä¸ºé»‘è‰²ï¼Œå°±è®¾ç½®è¿™ä¸ª`flag`ï¼Œå¦‚æœå¸Œæœ›çŠ¶æ€æ æ–‡å­—ä¸ºç™½è‰²ï¼Œå°±å°†è¿™ä¸ª`flag`ä»`systemUiVisibility`ä¸­å‰”é™¤

å¯èƒ½æœ‰å°ä¼™ä¼´ä¸å¤ªäº†è§£`kotlin`ä¸­çš„ä½è¿ç®—ï¼Œ`kotlin`ä¸­çš„`or`ã€`and`ã€`inv`åˆ†åˆ«å¯¹åº”ç€æˆ–ã€ä¸ã€å–åè¿ç®—

æ‰€ä»¥

```
systemUiVisibility and View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR.inv()


```

ç¿»è¯‘æˆ`java`å³ä¸º

```
systemUiVisibility & ~View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR


```

åœ¨åŸç”Ÿç³»ç»Ÿä¸Šï¼Œè¿™ä¹ˆè®¾ç½®å°±å¯ä»¥æˆåŠŸè®¾ç½®çŠ¶æ€æ æ–‡å­—é¢œè‰²ï¼Œä½†æˆ‘å‘ç°ï¼Œåœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œè¿™æ ·è®¾ç½®åçš„æ•ˆæœæ˜¯ä¸å¯é¢„æœŸçš„ï¼Œè­¬å¦‚`MIUI`ç³»ç»Ÿçš„çŠ¶æ€æ æ–‡å­—é¢œè‰²ä¼¼ä¹æ˜¯æ ¹æ®çŠ¶æ€æ èƒŒæ™¯é¢œè‰²è‡ªé€‚åº”çš„ï¼Œä¸”æ—¥é—´æ¨¡å¼å’Œé»‘å¤œæ¨¡å¼ä¸‹çš„è‡ªé€‚åº”ç­–ç•¥è¿˜ç•¥æœ‰ä¸åŒã€‚ä¸è¿‡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒè‡ªé€‚åº”çš„é¢œè‰²éƒ½æ˜¯æ­£å¸¸çš„ï¼Œæˆ‘ä»¬å°±æŒ‰ç…§æˆ‘ä»¬å¸Œæœ›çš„ç»“æœè®¾ç½®å°±å¯ä»¥äº†ã€‚

çŸ«æ­£æ˜¾ç¤ºåŒºåŸŸ
------

### fitsSystemWindows

çŸ«æ­£çŠ¶æ€æ æ˜¾ç¤ºåŒºåŸŸæœ€ç®€å•çš„åŠæ³•å°±æ˜¯è®¾ç½®`fitsSystemWindows`å±æ€§ï¼Œè®¾ç½®äº†è¯¥å±æ€§çš„`View`çš„æ‰€æœ‰`padding`å±æ€§éƒ½å°†å¤±æ•ˆï¼Œå¹¶ä¸”ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºå…¶æ·»åŠ `paddingTop`ï¼ˆè®¾ç½®äº†é€æ˜çŠ¶æ€æ çš„æƒ…å†µä¸‹ï¼‰å’Œ`paddingBottom`ï¼ˆè®¾ç½®äº†é€æ˜å¯¼èˆªæ çš„æƒ…å†µä¸‹ï¼‰

æˆ‘ä¸ªäººæ˜¯ä¸ç”¨è¿™ç§æ–¹å¼çš„ï¼Œé¦–å…ˆå®ƒä¼šè¦†ç›–ä½ è®¾ç½®çš„`padding`ï¼Œå…¶æ¬¡ï¼Œå¦‚æœä½ åŒæ—¶è®¾ç½®äº†é€æ˜çŠ¶æ€æ å’Œé€æ˜å¯¼èˆªæ ï¼Œè¿™ä¸ªå±æ€§æ²¡æœ‰åŠæ³•åˆ†å¼€æ¥å¤„ç†ï¼Œå¾ˆä¸çµæ´»

### è·å–çŠ¶æ€æ é«˜åº¦

é™¤äº†`fitsSystemWindows`è¿™ç§æ–¹æ³•å¤–ï¼Œå…¶ä»–çš„æ–¹æ³•éƒ½å¾—ä¾é è·å–çŠ¶æ€æ é«˜åº¦äº†ï¼Œè¿™é‡Œç›´æ¥ä¸Šä»£ç 

```
fun getStatusBarHeight(context: Context): Int {
    val resId = context.resources.getIdentifier(
        "status_bar_height", "dimen", "android"
    )
    return context.resources.getDimensionPixelSize(resId)
}


```

çŠ¶æ€æ ä¸åƒå¯¼èˆªæ é‚£æ ·å¤šå˜ï¼Œæ‰€ä»¥ç›´æ¥è¿™æ ·è·å–é«˜åº¦å°±å¯ä»¥äº†ï¼Œå¯¼èˆªæ çš„é«˜åº¦é£˜å¿½ä¸å®šæ‰æ˜¯çœŸæ­£çš„å™©æ¢¦

è¿™é‡Œå†ç»™ä¸¤ä¸ªè®¾ç½®`View` `margin`æˆ–`padding`çš„å·¥å…·æ–¹æ³•å§ï¼Œå¸®åŠ©å¤§å®¶å¿«é€Ÿä½¿ç”¨

```
fun fixStatusBarMargin(vararg views: View) {
    views.forEach { view ->
        (view.layoutParams as? ViewGroup.MarginLayoutParams)?.let { lp ->
            lp.topMargin = lp.topMargin + getStatusBarHeight(view.context)
            view.requestLayout()
        }
    }
}

fun paddingByStatusBar(view: View) {
    view.setPadding(
        view.paddingLeft,
        view.paddingTop + getStatusBarHeight(view.context),
        view.paddingRight,
        view.paddingBottom
    )
}


```

æ²‰æµ¸å¼å¯¼èˆªæ 
======

æ²‰æµ¸å¼å¯¼èˆªæ ç›¸æ¯”æ²‰æµ¸å¼çŠ¶æ€æ å‘ä¼šå¤šå¾ˆå¤šï¼Œå…·ä½“åŸå› æˆ‘ä»¬åé¢å†è¯´

å¯¼èˆªæ é€æ˜
-----

å’Œæ²‰æµ¸å¼çŠ¶æ€æ ä¸€æ ·ï¼Œç¬¬ä¸€æ­¥æˆ‘ä»¬éœ€è¦å°†å¯¼èˆªæ çš„èƒŒæ™¯è®¾ç½®ä¸ºé€æ˜

```
fun transparentNavigationBar(window: Window) {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
        window.isNavigationBarContrastEnforced = false
    }
    window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_NAVIGATION)
    window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS)
    var systemUiVisibility = window.decorView.systemUiVisibility
    systemUiVisibility =
        systemUiVisibility or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
    window.decorView.systemUiVisibility = systemUiVisibility
    window.navigationBarColor = Color.TRANSPARENT

    //è®¾ç½®å¯¼èˆªæ æŒ‰é’®æˆ–å¯¼èˆªæ¡é¢œè‰²
    setNavigationBarBtnColor(window, NightMode.isNightMode(window.context))
}


```

åœ¨`Android 10`ä»¥ä¸Šï¼Œå½“è®¾ç½®äº†å¯¼èˆªæ æ èƒŒæ™¯ä¸ºé€æ˜æ—¶ï¼Œ`isNavigationBarContrastEnforced`å¦‚æœä¸º`true`ï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨ç»˜åˆ¶ä¸€ä¸ªåŠé€æ˜èƒŒæ™¯æ¥æä¾›å¯¹æ¯”åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†è¿™ä¸ªå±æ€§è®¾ä¸º`false`

psï¼šçŠ¶æ€æ å…¶å®ä¹Ÿæœ‰å¯¹åº”çš„å±æ€§`isStatusBarContrastEnforced`ï¼Œåªä¸è¿‡è¿™ä¸ªå±æ€§é»˜è®¤å³ä¸º`false`ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç‰¹æ„å»è®¾ç½®

å¯¼èˆªæ æŒ‰é’®æˆ–å¯¼èˆªæ¡é¢œè‰²
-----------

å’Œè®¾ç½®çŠ¶æ€æ æ–‡å­—é¢œè‰²ä¸€æ ·ï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šä»‹ç»äº†

```
fun setNavigationBarBtnColor(window: Window, light: Boolean) {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        var systemUiVisibility = window.decorView.systemUiVisibility
        systemUiVisibility = if (light) { //ç™½è‰²æŒ‰é’®
            systemUiVisibility and View.SYSTEM_UI_FLAG_LIGHT_NAVIGATION_BAR.inv()
        } else { //é»‘è‰²æŒ‰é’®
            systemUiVisibility or View.SYSTEM_UI_FLAG_LIGHT_NAVIGATION_BAR
        }
        window.decorView.systemUiVisibility = systemUiVisibility
    }
}


```

çŸ«æ­£æ˜¾ç¤ºåŒºåŸŸ
------

### fitsSystemWindows

å’ŒçŠ¶æ€æ ä½¿ç”¨ä¸€æ ·ï¼Œæˆ‘å°±ä¸é‡å¤è¯´æ˜äº†

### è·å–å¯¼èˆªæ é«˜åº¦

è‡ªä»å…¨é¢å±æ‰‹åŠ¿å¼€å§‹æµè¡Œï¼Œå¯¼èˆªæ ä¹Ÿä»åŸå…ˆçš„ä¸‰é”®å¼ï¼Œå˜æˆäº†ä¸‰é”®å¼ã€å¯¼èˆªæ¡ã€å…¨éšè—è¿™ä¸‰ç§æƒ…å†µï¼Œè¿™ä¸‰ç§æƒ…å†µä¸‹çš„é«˜åº¦ä¹Ÿæ˜¯äº’ä¸ç›¸åŒçš„

ä¸‰é”®å¼å’Œå¯¼èˆªæ¡è¿™ä¸¤ç§æƒ…å†µæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡`android.R.dimen.navigation_bar_height`è¿™ä¸ªèµ„æºè·å–åˆ°å‡†ç¡®é«˜åº¦ï¼Œä½†ç°åœ¨å¾ˆå¤šç³»ç»Ÿéƒ½æ”¯æŒéšè—å¯¼èˆªæ çš„åŠŸèƒ½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè™½ç„¶å®é™…å¯¼èˆªæ çš„é«˜åº¦åº”è¯¥æ˜¯ 0ï¼Œä½†æ˜¯é€šè¿‡èµ„æºè·å–åˆ°çš„é«˜åº¦å´ä¸ºä¸‰é”®å¼æˆ–å¯¼èˆªæ¡çš„é«˜åº¦ï¼Œè¿™å°±ç»™æˆ‘ä»¬æ²‰æµ¸å¼å¯¼èˆªæ çš„é€‚é…å¸¦æ¥äº†å¾ˆå¤§å›°éš¾

ç»è¿‡æˆ‘çš„å„ç§å°è¯•ï¼Œæˆ‘å‘ç°åªæœ‰ä¸€ç§æ–¹å¼å¯ä»¥å‡†ç¡®çš„è·å–åˆ°å½“å‰å¯¼èˆªæ çš„é«˜åº¦ï¼Œé‚£å°±æ˜¯`WindowInsets`ï¼Œè‡³äº`WindowInsets`æ˜¯ä»€ä¹ˆæˆ‘å°±ä¸å¤šä»‹ç»äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç 

```
/**
* ä»…å½“view attach windowåç”Ÿæ•ˆ
*/
private fun getRealNavigationBarHeight(view: View): Int {
    val insets = ViewCompat.getRootWindowInsets(view)
        ?.getInsets(WindowInsetsCompat.Type.navigationBars())
    //WindowInsetsä¸ºnullåˆ™é»˜è®¤é€šè¿‡èµ„æºè·å–é«˜åº¦
    return insets?.bottom ?: getNavigationBarHeight(view.context)
}


```

è¿™é‡Œéœ€è¦æ³¨æ„åˆ°æˆ‘åœ¨æ–¹æ³•ä¸Šå†™çš„æ³¨é‡Šï¼Œåªæœ‰å½“`View`å’Œ`Window` attach åï¼Œæ‰èƒ½è·å¾—åˆ°`WindowInsets`ï¼Œå¦åˆ™ä¸º`null`ï¼Œæ‰€ä»¥æˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯å…ˆæ£€æŸ¥`View`æ˜¯å¦ attach äº†`Window`ï¼Œå¦‚æœæœ‰çš„è¯åˆ™ç›´æ¥è°ƒç”¨`getRealNavigationBarHeight`æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè°ƒç”¨`View.addOnAttachStateChangeListener`æ–¹æ³•ï¼Œå½“å‡ºå‘`attach`å›è°ƒåï¼Œå†è°ƒç”¨`getRealNavigationBarHeight`æ–¹æ³•è·å–é«˜åº¦

è¿™ç§æ–¹å¼åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿è¡Œè‰¯å¥½ï¼Œä½†åœ¨æˆ‘ä¸€æ¬¡æ— æ„ä¸­åˆ‡æ¢äº†ç³»ç»Ÿå¤œé—´æ¨¡å¼åå‘ç°ï¼Œè·å–åˆ°çš„å¯¼èˆªæ é«˜åº¦å˜æˆäº† 0ï¼Œå¹¶ä¸”è¿™è¿˜æ˜¯ä¸€ä¸ªå¶ç°çš„é—®é¢˜ï¼Œäºæ˜¯æˆ‘å°è¯•ä½¿ç”¨`View.setOnApplyWindowInsetsListener`ï¼Œç›‘å¬`WindowInsets`çš„å˜åŒ–å‘ç°ï¼Œè¿™ä¸ªå›è°ƒæœ‰å¯èƒ½ä¼šè§¦å‘å¤šæ¬¡ï¼Œåœ¨è§¦å‘å¤šæ¬¡çš„æƒ…å†µä¸‹ï¼Œå‰å‡ æ¬¡çš„å€¼éƒ½ä¸º 0ï¼Œåªæœ‰æœ€åä¸€æ¬¡çš„å€¼ä¸ºçœŸæ­£çš„å¯¼èˆªæ é«˜åº¦

äºæ˜¯æˆ‘å‡†å¤‡ç”¨`View.setOnApplyWindowInsetsListener`ä»£æ›¿`View.addOnAttachStateChangeListener`ï¼Œä½†æ¯•ç«Ÿä¸€ä¸ªæ˜¯ setListenerï¼Œä¸€ä¸ªæ˜¯ addListenerï¼ŒsetListener æœ‰å¯èƒ½ä¼šæŠŠä¹‹å‰è®¾ç½®å¥½çš„ Listener è¦†ç›–ï¼Œæˆ–è€…è¢«åˆ«çš„ Listener è¦†ç›–æ‰ï¼Œå†è€ƒè™‘åˆ°ä¹‹åä¼šæåˆ°çš„åº•éƒ¨`Dialog`æ²‰æµ¸å¼å¯¼èˆªæ é€‚é…çš„é—®é¢˜ï¼Œæˆ‘æŠ˜ä¸­äº†ä¸€ä¸‹ï¼Œå†³å®šåªå¯¹`Activity`ä¸‹çš„`rootView`è®¾ç½®å›è°ƒ

ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç 

```
private class NavigationViewInfo(
    val hostRef: WeakReference<View>,
    val viewRef: WeakReference<View>,
    val rawBottom: Int,
    val onNavHeightChangeListener: (View, Int, Int) -> Unit
)

private val navigationViewInfoList = mutableListOf<NavigationViewInfo>()

private val onApplyWindowInsetsListener = View.OnApplyWindowInsetsListener { v, insets ->
    val windowInsetsCompat = WindowInsetsCompat.toWindowInsetsCompat(insets, v)
    val navHeight =
        windowInsetsCompat.getInsets(WindowInsetsCompat.Type.navigationBars()).bottom
    val it = navigationViewInfoList.iterator()
    while (it.hasNext()) {
        val info = it.next()
        val host = info.hostRef.get()
        val view = info.viewRef.get()
        if (host == null || view == null) {
            it.remove()
            continue
        }

        if (host == v) {
            info.onNavHeightChangeListener(view, info.rawBottom, navHeight)
        }
    }
    insets
}

private val actionMarginNavigation: (View, Int, Int) -> Unit =
    { view, rawBottomMargin, navHeight ->
        (view.layoutParams as? ViewGroup.MarginLayoutParams)?.let {
            it.bottomMargin = rawBottomMargin + navHeight
            view.requestLayout()
        }
    }

private val actionPaddingNavigation: (View, Int, Int) -> Unit =
    { view, rawBottomPadding, navHeight ->
        view.setPadding(
            view.paddingLeft,
            view.paddingTop,
            view.paddingRight,
            rawBottomPadding + navHeight
        )
    }

fun fixNavBarMargin(vararg views: View) {
    views.forEach {
        fixSingleNavBarMargin(it)
    }
}

private fun fixSingleNavBarMargin(view: View) {
    val lp = view.layoutParams as? ViewGroup.MarginLayoutParams ?: return
    val rawBottomMargin = lp.bottomMargin

    val viewForCalculate = getViewForCalculate(view)

    if (viewForCalculate.isAttachedToWindow) {
        val realNavigationBarHeight = getRealNavigationBarHeight(viewForCalculate)
        lp.bottomMargin = rawBottomMargin + realNavigationBarHeight
        view.requestLayout()
    }
    
    //isAttachedToWindowæ–¹æ³•å¹¶ä¸èƒ½ä¿è¯æ­¤æ—¶çš„WindowInsetsæ˜¯æ­£ç¡®çš„ï¼Œä»ç„¶éœ€è¦æ·»åŠ ç›‘å¬
    val hostRef = WeakReference(viewForCalculate)
    val viewRef = WeakReference(view)
    val info = NavigationViewInfo(hostRef, viewRef, rawBottomMargin, actionMarginNavigation)
    navigationViewInfoList.add(info)
    viewForCalculate.setOnApplyWindowInsetsListener(onApplyWindowInsetsListener)
}

fun paddingByNavBar(view: View) {
    val rawBottomPadding = view.paddingBottom

    val viewForCalculate = getViewForCalculate(view)

    if (viewForCalculate.isAttachedToWindow) {
        val realNavigationBarHeight = getRealNavigationBarHeight(viewForCalculate)
        view.setPadding(
            view.paddingLeft,
            view.paddingTop,
            view.paddingRight,
            rawBottomPadding + realNavigationBarHeight
        )
    }
    
    //isAttachedToWindowæ–¹æ³•å¹¶ä¸èƒ½ä¿è¯æ­¤æ—¶çš„WindowInsetsæ˜¯æ­£ç¡®çš„ï¼Œä»ç„¶éœ€è¦æ·»åŠ ç›‘å¬
    val hostRef = WeakReference(viewForCalculate)
    val viewRef = WeakReference(view)
    val info =
        NavigationViewInfo(hostRef, viewRef, rawBottomPadding, actionPaddingNavigation)
    navigationViewInfoList.add(info)
    viewForCalculate.setOnApplyWindowInsetsListener(onApplyWindowInsetsListener)
}

/**
* Dialogä¸‹çš„Viewåœ¨ä½ç‰ˆæœ¬æœºå‹ä¸­è·å–åˆ°çš„WindowInsetså€¼æœ‰è¯¯ï¼Œ
* æ‰€ä»¥å°è¯•å»è·å¾—Activityçš„contentViewï¼Œé€šè¿‡Activityçš„contentViewè·å–WindowInsets
*/
@SuppressLint("ContextCast")
private fun getViewForCalculate(view: View): View {
    return (view.context as? ContextWrapper)?.let {
        return@let (it.baseContext as? Activity)?.findViewById<View>(android.R.id.content)?.rootView
    } ?: view.rootView
}

/**
* ä»…å½“view attach windowåç”Ÿæ•ˆ
*/
private fun getRealNavigationBarHeight(view: View): Int {
    val insets = ViewCompat.getRootWindowInsets(view)
        ?.getInsets(WindowInsetsCompat.Type.navigationBars())
    return insets?.bottom ?: getNavigationBarHeight(view.context)
}


```

æˆ‘ç®€å•è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ï¼šä¸ºæ‰€æœ‰éœ€è¦æ²‰æµ¸çš„é¡µé¢çš„æ ¹`View`è®¾ç½®åŒä¸€ä¸ªå›è°ƒï¼Œå¹¶å°†å¾…é€‚é…å¯¼èˆªæ é«˜åº¦çš„`View`æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œå½“`WindowInsets`å›è°ƒè§¦å‘åï¼Œéå†è¿™ä¸ªåˆ—è¡¨ï¼Œåˆ¤æ–­è§¦å‘å›è°ƒçš„`View`çš„`host`æ˜¯å¦ä¸å¾…é€‚é…å¯¼èˆªæ é«˜åº¦çš„`View`å¯¹åº”ï¼Œå¯¹åº”çš„è¯åˆ™å¤„ç†`View`é€‚é…å¯¼èˆªæ é«˜åº¦

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œ`WindowInsets`çš„åˆ†å‘å…¶å®æ˜¯åœ¨`dispatchAttachedToWindow`ä¹‹åçš„ï¼Œæ‰€ä»¥`isAttachedToWindow`æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯æ­¤æ—¶çš„`WindowInsets`æ˜¯æ­£ç¡®çš„ï¼Œå…·ä½“å¯ä»¥å»çœ‹`ViewRootImpl`ä¸­çš„æºç ï¼Œå…³é”®æ–¹æ³•ï¼š`dispatchApplyInsets`ï¼Œè¿™é‡Œåˆ¤æ–­`isAttachedToWindow`å¹¶è®¾ç½®é«˜åº¦æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°`View`å·²ç»å®Œå…¨å¸ƒå±€å®Œæˆï¼Œä¹‹åå†ä¹Ÿä¸ä¼šè§¦å‘`OnApplyWindowInsets`çš„æƒ…å†µ

è¿™é‡Œæˆ‘ä¹Ÿæµ‹è¯•äº†å†…å­˜æ³„æ¼æƒ…å†µï¼Œç¡®è®¤æ— å†…å­˜æ³„æ¼ï¼Œå¤§å®¶å¯ä»¥æ”¾å¿ƒé£Ÿç”¨

åº•éƒ¨ Dialog é€‚é…æ²‰æµ¸å¼
===============

åº•éƒ¨`Dialog`é€‚é…æ²‰æµ¸å¼è¦æ¯”æ­£å¸¸çš„`Activity`æ›´éº»çƒ¦ä¸€äº›ï¼Œä¸»è¦é—®é¢˜ä¹Ÿæ˜¯é›†ä¸­åœ¨æ²‰æµ¸å¼å¯¼èˆªæ ä¸Š

è·å–å¯¼èˆªæ é«˜åº¦
-------

ä»”ç»†çš„å°ä¼™ä¼´ä»¬å¯ä»¥å·²ç»æ³¨æ„åˆ°äº†æˆ‘åœ¨æ²‰æµ¸å¼å¯¼èˆªæ è·å–é«˜åº¦é‚£é‡Œä»£ç ä¸­çš„æ³¨é‡Šï¼Œ`Dialog`ä¸‹çš„`View`åœ¨ä½ç‰ˆæœ¬æœºå‹ï¼ˆç»æµ‹è¯•ï¼Œ`Android 9`ä¸€ä¸‹å°±ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼‰ä¸­è·å–åˆ°çš„`WindowInsets`å€¼æœ‰è¯¯ï¼Œæ‰€ä»¥å°è¯•å»è·å¾—`Activity`çš„`contentView`ï¼Œé€šè¿‡`Activity`çš„`contentView`è·å–`WindowInsets`

LayoutParams å¯¼è‡´çš„å¼‚å¸¸
------------------

åœ¨æŸäº›ç³»ç»Ÿä¸Šï¼ˆæ¯”å¦‚ MIUIï¼‰ï¼Œå½“æˆ‘`window.setLayout(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)`æ—¶ï¼Œæ²‰æµ¸å¼ä¼šå‡ºç°é—®é¢˜ï¼ŒçŠ¶æ€æ ä¼šè¢«è’™å±‚ç›–ä½ï¼Œ`Dialog`åº•éƒ¨çš„å†…å®¹ä¹Ÿä¼šè¢«ä¸€ä¸ªè«åå…¶å¦™çš„ä¸œè¥¿é®æŒ¡ä½

æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œ`window.setLayout(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)`ï¼Œç„¶åå¸ƒå±€æœ€å¤–å±‚å…¨éƒ¨å æ»¡ï¼Œå†…éƒ¨ç•™ä¸€ä¸ªåº•éƒ¨å®¹å™¨

```
<!-- dialog_pangu_bottom_wrapper -->
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@android:color/transparent">

    <FrameLayout
        android:id="@+id/pangu_bottom_dialog_container"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_gravity="bottom"
        android:clickable="true"
        android:focusable="true" />

</FrameLayout>


```

ç„¶ååœ¨ä»£ç ä¸­é‡å†™`setContentView`æ–¹æ³•

```
private var canceledOnTouchOutside = true

override fun setContentView(layoutResID: Int) {
    setContentView(
        LayoutInflater.from(context).inflate(layoutResID, null, false)
    )
}

override fun setContentView(view: View) {
    setContentView(
        view,
        ViewGroup.LayoutParams(
            ViewGroup.LayoutParams.MATCH_PARENT,
            ViewGroup.LayoutParams.WRAP_CONTENT
        )
    )
}

override fun setContentView(view: View, params: ViewGroup.LayoutParams?) {
    val root =
        LayoutInflater.from(context).inflate(R.layout.dialog_pangu_bottom_wrapper, null, false)
    root.setOnClickListener {
        if (canceledOnTouchOutside) {
            dismiss()
        }
    }
    val container = root.findViewById<ViewGroup>(R.id.pangu_bottom_dialog_container)
    container.addView(view, params)

    super.setContentView(
        root,
        ViewGroup.LayoutParams(
            ViewGroup.LayoutParams.MATCH_PARENT,
            ViewGroup.LayoutParams.MATCH_PARENT
        )
    )
}

override fun setCanceledOnTouchOutside(cancel: Boolean) {
    super.setCanceledOnTouchOutside(cancel)
    canceledOnTouchOutside = cancel
}


```

è¿™æ ·çš„è¯è§†è§‰æ•ˆæœå°±å’Œæ™®é€šçš„åº•éƒ¨`Dialog`ä¸€æ ·äº†ï¼Œä¸ºäº†è¿›ä¸€æ­¥å‡å°åº•éƒ¨`Dialog`æ˜¾ç¤ºéšè—åŠ¨ç”»ä¹‹é—´çš„å·®å¼‚ï¼Œæˆ‘å°†åŠ¨ç”»æ’å€¼å™¨ä»`linear_interpolator`æ¢æˆäº†`decelerate_interpolator`å’Œ`accelerate_interpolator`

```
<!-- dialog_enter_from_bottom_to_top -->
<translate xmlns:android="http://schemas.android.com/apk/res/android"
    android:duration="300"
    android:fromYDelta="100%"
    android:interpolator="@android:anim/decelerate_interpolator"
    android:toYDelta="0" />


```

```
<!-- dialog_exit_from_top_to_bottom -->
<translate xmlns:android="http://schemas.android.com/apk/res/android"
    android:duration="300"
    android:fromYDelta="0"
    android:interpolator="@android:anim/accelerate_interpolator"
    android:toYDelta="100%" />


```

å°¾å£°
==

è‡ªæ­¤ï¼Œç›®å‰æ²‰æµ¸å¼é‡åˆ°çš„é—®é¢˜å…¨éƒ¨éƒ½è§£å†³äº†ï¼Œå¦‚æœä»¥åå‘ç°äº†ä»€ä¹ˆæ–°çš„é—®é¢˜ï¼Œæˆ‘ä¼šåœ¨è¿™ç¯‡æ–‡ç« ä¸­è¡¥å……è¯´æ˜ï¼Œå¦‚æœè¿˜æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹å¯ä»¥è¯„è®ºï¼Œæˆ‘è€ƒè™‘è¦ä¸è¦æ‹¿å‡ ä¸ªå…·ä½“çš„åœºæ™¯å®æˆ˜è®²è§£ï¼Œå„ä½çœ‹å®˜è€çˆ·éº»çƒ¦ç‚¹ä¸ªèµæ”¶ä¸ªè—ä¸è¿·è·¯ğŸ˜„